#!/usr/bin/env python3
"""
å†å²ç§‘å­¦ç±»ç§‘æ™®çŸ­è§†é¢‘ç´ æç”Ÿæˆè„šæœ¬
è‡ªåŠ¨ç”Ÿæˆ3åˆ†é’Ÿç§‘æ™®è§†é¢‘çš„å…¨æµç¨‹ç´ æï¼šå£æ’­æ–‡æ¡ˆã€åˆ†é•œè„šæœ¬ã€Veo2æç¤ºè¯ã€äººç‰©å½¢è±¡è§„èŒƒ
"""

import os
import argparse
import sys
import json
from typing import Dict, List, Any
from langchain_core.messages import SystemMessage, HumanMessage
from langchain_openai import ChatOpenAI
from coze_workload_identity import requests


# ==================== é…ç½®å¸¸é‡ ====================
SKILL_ID = "7598365825573257262"
BASE_URL = os.getenv("COZE_LLM_BASE_URL", "")
API_KEY = os.getenv("COZE_LLM_API_KEY", "")

# ==================== æ–‡æ¡ˆç»“æ„é…ç½® ====================
SCRIPT_STRUCTURE = {
    "å¼€ç¯‡æ‚¬å¿µ": {"duration": 20, "content": "ç”¨[å¹´ä»½]+[ç§‘å­¦äº‹ä»¶/äººç‰©å›°æƒ‘]å¼€å¤´ï¼Œå¼•å‘è§‚ä¼—å¥½å¥‡"},
    "å†å²èƒŒæ™¯": {"duration": 30, "content": "äº¤ä»£æ—¶ä»£ã€åœ°ç‚¹ã€å­¦æœ¯æˆ–ç¤¾ä¼šèƒŒæ™¯"},
    "äººç‰©æå†™": {"duration": 25, "content": "çªå‡ºç§‘å­¦å®¶çš„ç‰¹è´¨ï¼ˆåšæŒã€åæ‰§ã€çƒ­æƒ…ã€å¤©æ‰ï¼‰"},
    "äº‹ä»¶ä¸å®éªŒç»†èŠ‚": {"duration": 45, "content": "æ•°å­—åŒ–æå†™å®éªŒå¯¹è±¡ã€æ–¹æ³•ã€æ•°é‡ã€æ—¶é—´ã€ç©ºé—´"},
    "å‘ç°ä¸çªç ´": {"duration": 35, "content": "æ˜ç¡®ç§‘å­¦ç»“è®ºæˆ–è§„å¾‹ï¼Œç”¨ç”ŸåŠ¨è¯­è¨€å¼ºè°ƒå…¶é‡è¦æ€§"},
    "æ„ä¹‰ä¸å½±å“": {"duration": 30, "content": "è§£é‡Šç§‘å­¦å‘ç°å¦‚ä½•æ”¹å˜å­¦ç•Œã€ç¤¾ä¼šæˆ–æ–‡åŒ–"},
    "ç»“å°¾åæ€": {"duration": 15, "content": "æå‡ºæ·±æ€æˆ–æœªæ¥æ¢ç´¢é—®é¢˜"}
}

TOTAL_DURATION = sum(sec["duration"] for sec in SCRIPT_STRUCTURE.values())  # 200ç§’ = 3åˆ†20ç§’
TARGET_WORD_COUNT = 900  # 3åˆ†é’Ÿçº¦900å­—


# ==================== å¤å¤é£æ ¼é…ç½® ====================
RETRO_STYLE = """
å¤å¤ç…§ç‰‡é£æ ¼è¦æ±‚ï¼š
- è‰²è°ƒï¼šæ£•è¤è‰²è°ƒï¼Œè‰²å½©æ²‰ç¨³åæ£•è‰²
- è´¨æ„Ÿï¼šè½»å¾®è¤ªè‰²ï¼Œèƒ¶ç‰‡é¢—ç²’æ„Ÿï¼Œæ¡£æ¡ˆæ„Ÿ
- å…‰å½±ï¼šæŸ”å’Œé˜´å½±ï¼Œå†å²çœŸå®æ„Ÿ
- æ³¨æ„äº‹é¡¹ï¼šä¸¥æ ¼ç¦æ­¢å‡ºç°ä¸å±äºæœ¬å¹´ä»£ä¹‹å¤–çš„åœºæ™¯æˆ–ç‰©å“
"""


# ==================== Veo2 æç¤ºè¯æ¨¡æ¿ ====================
VEO2_PROMPT_TEMPLATE = """
ä¸»ä½“ï¼ˆSubjectï¼‰ï¼š
- è§†é¢‘çš„ä¸»è¦å¯¹è±¡æ˜¯ä»€ä¹ˆ
- å¯¹è±¡çš„ç‰¹å¾å’Œç»†èŠ‚
- å¯¹è±¡çš„æ•°é‡ï¼ˆå¦‚æœæ˜¯å¤šä¸ªï¼‰

åŠ¨ä½œï¼ˆActionï¼‰ï¼š
- åœºæ™¯ä¸­å‘ç”Ÿä»€ä¹ˆåŠ¨ä½œ
- åŠ¨ä½œçš„é€Ÿåº¦å’ŒèŠ‚å¥
- åŠ¨ä½œçš„è¿ç»­æ€§

åœºæ™¯ï¼ˆSettingï¼‰ï¼š
- ç¯å¢ƒæè¿°
- èƒŒæ™¯å…ƒç´ 
- ç©ºé—´æ„Ÿ

é•œå¤´è§’åº¦ï¼ˆCamera Angle/Movementï¼‰ï¼š
- é•œå¤´ç±»å‹ï¼ˆç‰¹å†™ã€è¿œæ™¯ç­‰ï¼‰
- é•œå¤´è¿åŠ¨ï¼ˆå¹³ç§»ã€æ¨è¿›ç­‰ï¼‰
- è§†è§’å˜åŒ–

ç¯å…‰ï¼ˆLightingï¼‰ï¼š
- å…‰æºç±»å‹
- å…‰çº¿å¼ºåº¦
- å…‰å½±æ•ˆæœ

é£æ ¼/æƒ…ç»ªï¼ˆStyle/Moodï¼‰ï¼š
- è§†è§‰é£æ ¼ï¼šæ£•è¤è‰²è°ƒï¼Œå¤å¤å†å²ç…§ç‰‡è´¨æ„Ÿï¼Œè½»å¾®è¤ªè‰²æ•ˆæœï¼Œç»†è…»èƒ¶ç‰‡é¢—ç²’æ„Ÿï¼ŒæŸ”å’Œé˜´å½±
- æƒ…æ„Ÿæ°›å›´ï¼šæ ¹æ®æ–‡æ¡ˆæƒ…ç»ªè°ƒæ•´ï¼ˆæ‚¬å¿µ/ä¸¥è‚ƒ/æ¿€æ˜‚/æ²‰é™ï¼‰
- è‰ºæœ¯æ•ˆæœï¼šå†å²çœŸå®æ„Ÿä¸æ¡£æ¡ˆæ„Ÿæ‹‰æ»¡ï¼Œæ— ä»»ä½•è·¨å¹´ä»£å…ƒç´ 
"""


# ==================== å¤§æ¨¡å‹è°ƒç”¨ ====================
async def call_llm(prompt: str, temperature: float = 0.7) -> str:
    """è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå†…å®¹"""
    if not BASE_URL or not API_KEY:
        raise ValueError("ç¼ºå°‘å¤§æ¨¡å‹å‡­è¯é…ç½®ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ COZE_LLM_BASE_URL å’Œ COZE_LLM_API_KEY")
    
    llm = ChatOpenAI(
        model="doubao-seed-1-6-251015",
        api_key=API_KEY,
        base_url=BASE_URL,
        streaming=False,
        temperature=temperature,
        max_tokens=4000,
        extra_body={"thinking": {"type": "disabled"}}
    )
    
    messages = [
        SystemMessage(content="""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç§‘æ™®çŸ­è§†é¢‘åˆ¶ä½œä¸“å®¶ï¼Œæ“…é•¿åˆ›ä½œå†å²ç§‘å­¦ç±»è§†é¢‘ç´ æã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸»é¢˜ã€å¹´ä»£å’Œæ ¸å¿ƒç»“è®ºï¼Œç”Ÿæˆé«˜è´¨é‡çš„ç§‘æ™®æ–‡æ¡ˆã€åˆ†é•œè„šæœ¬å’Œè§†è§‰æç¤ºè¯ã€‚

è¾“å‡ºè¦æ±‚ï¼š
1. æ–‡æ¡ˆï¼šè¯­è¨€å£è¯­åŒ–ã€ç”Ÿæ´»åŒ–ï¼Œä½†ä¿ç•™ç§‘å­¦å‡†ç¡®æ€§ï¼›å¤šç”¨æ•°å­—ã€å¹´ä»½ã€æ•°é‡å¢å¼ºçœŸå®æ„Ÿï¼›çŸ­å¥ä¸é•¿å¥äº¤æ›¿ï¼Œå¢å¼ºèŠ‚å¥æ„Ÿ
2. åˆ†é•œï¼šæ¯é•œå¯¹åº”1-2å¥æ–‡æ¡ˆï¼Œæ—¶é•¿4-6ç§’ï¼›ä¿æŒå¤å¤ç…§ç‰‡é£æ ¼ï¼›ç”»é¢è¿ç»­æ€§å’Œè¡”æ¥æ€§
3. æç¤ºè¯ï¼šä½¿ç”¨Veo2æ ‡å‡†æ ¼å¼ï¼Œæ¶µç›–ä¸»ä½“ã€åŠ¨ä½œã€åœºæ™¯ã€é•œå¤´è§’åº¦ã€ç¯å…‰ã€é£æ ¼/æƒ…ç»ª
4. äººç‰©ï¼šä¿æŒäººç‰©ä¸€è‡´æ€§ï¼Œæœé¥°å’Œé“å…·ä¸¥æ ¼è´´åˆå¯¹åº”å¹´ä»£

è¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ é¢å¤–çš„è¯´æ˜æ–‡å­—ã€‚"""),
        HumanMessage(content=prompt)
    ]
    
    try:
        response = await llm.ainvoke(messages)
        return response.content
    except Exception as e:
        raise Exception(f"å¤§æ¨¡å‹è°ƒç”¨å¤±è´¥: {str(e)}")


# ==================== æ–‡æ¡ˆç”Ÿæˆ ====================
async def generate_script(theme: str, era: str, core_conclusion: str) -> str:
    """ç”Ÿæˆ3åˆ†é’Ÿå£æ’­æ–‡æ¡ˆ"""
    prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª3åˆ†é’Ÿçš„å†å²ç§‘å­¦ç±»ç§‘æ™®çŸ­è§†é¢‘å£æ’­æ–‡æ¡ˆï¼š

ã€ä¸»é¢˜ã€‘ï¼š{theme}
ã€å¹´ä»£èƒŒæ™¯ã€‘ï¼š{era}
ã€æ ¸å¿ƒç§‘å­¦ç»“è®ºã€‘ï¼š{core_conclusion}

ã€æ–‡æ¡ˆç»“æ„è¦æ±‚ã€‘ï¼ˆä¸¥æ ¼æŒ‰é¡ºåºï¼Œæ€»æ—¶é•¿çº¦3åˆ†é’Ÿï¼‰ï¼š
1. å¼€ç¯‡æ‚¬å¿µï¼ˆ20ç§’ï¼‰ï¼šç”¨ [å¹´ä»½]+[ç§‘å­¦äº‹ä»¶/äººç‰©å›°æƒ‘] å¼€å¤´ï¼Œå¼•å‘è§‚ä¼—å¥½å¥‡
2. å†å²èƒŒæ™¯ï¼ˆ30ç§’ï¼‰ï¼šäº¤ä»£æ—¶ä»£ã€åœ°ç‚¹ã€å­¦æœ¯æˆ–ç¤¾ä¼šèƒŒæ™¯
3. äººç‰©æå†™ï¼ˆ25ç§’ï¼‰ï¼šçªå‡ºç§‘å­¦å®¶çš„ç‰¹è´¨ï¼ˆåšæŒã€åæ‰§ã€çƒ­æƒ…ã€å¤©æ‰ï¼‰
4. äº‹ä»¶ä¸å®éªŒç»†èŠ‚ï¼ˆ45ç§’ï¼‰ï¼šæ•°å­—åŒ–æå†™å®éªŒå¯¹è±¡ã€æ–¹æ³•ã€æ•°é‡ã€æ—¶é—´ã€ç©ºé—´
5. å‘ç°ä¸çªç ´ï¼ˆ35ç§’ï¼‰ï¼šæ˜ç¡®ç§‘å­¦ç»“è®ºæˆ–è§„å¾‹ï¼Œç”¨ç”ŸåŠ¨è¯­è¨€å¼ºè°ƒå…¶é‡è¦æ€§
6. æ„ä¹‰ä¸å½±å“ï¼ˆ30ç§’ï¼‰ï¼šè§£é‡Šç§‘å­¦å‘ç°å¦‚ä½•æ”¹å˜å­¦ç•Œã€ç¤¾ä¼šæˆ–æ–‡åŒ–
7. ç»“å°¾åæ€ï¼ˆ15ç§’ï¼‰ï¼šæå‡ºæ·±æ€æˆ–æœªæ¥æ¢ç´¢é—®é¢˜

ã€è¯­è¨€ç‰¹ç‚¹ã€‘ï¼š
- ä½¿ç”¨çŸ­å¥ä¸é•¿å¥äº¤æ›¿ï¼Œå¢å¼ºèŠ‚å¥æ„Ÿ
- å£è¯­åŒ–ã€ç”Ÿæ´»åŒ–ï¼Œä½†ä¿ç•™ç§‘å­¦å‡†ç¡®æ€§
- å¤šç”¨æ•°å­—ã€å¹´ä»½ã€æ•°é‡å¢å¼ºçœŸå®æ„Ÿ
- é€‚å½“åŠ å…¥æ¯”å–»æˆ–ç±»æ¯”ï¼Œè®©æŠ½è±¡æ¦‚å¿µæ˜“ç†è§£

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
è¯·ç›´æ¥è¾“å‡ºæ–‡æ¡ˆå†…å®¹ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨ã€éƒ¨åˆ†åç§°ã€‘æ ‡æ³¨ï¼Œä¸è¦æ·»åŠ å…¶ä»–è¯´æ˜ã€‚

ç¤ºä¾‹æ ¼å¼ï¼š
ã€å¼€ç¯‡æ‚¬å¿µã€‘
1961å¹´å†¬å¤©ï¼Œéº»çœç†å·¥å­¦é™¢çš„ä¸€é—´å®éªŒå®¤é‡Œ...

ã€å†å²èƒŒæ™¯ã€‘
20ä¸–çºª60å¹´ä»£çš„ç¾å›½ï¼Œæ­£å€¼è®¡ç®—æœºç§‘å­¦è“¬å‹ƒå‘å±•çš„æ—¶æœŸ...

è¯·å¼€å§‹ç”Ÿæˆï¼š"""

    return await call_llm(prompt, temperature=0.8)


# ==================== äººç‰©å½¢è±¡ç”Ÿæˆ ====================
async def generate_character_design(script: str, era: str) -> str:
    """ç”Ÿæˆäººç‰©å½¢è±¡è§„èŒƒ"""
    prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹æ–‡æ¡ˆå’Œå¹´ä»£èƒŒæ™¯ï¼Œç”Ÿæˆç»Ÿä¸€ã€è´´åˆæ—¶ä»£çš„äººç‰©å½¢è±¡è§„èŒƒï¼š

ã€å£æ’­æ–‡æ¡ˆç‰‡æ®µã€‘ï¼š
{script[:1000]}

ã€å¹´ä»£èƒŒæ™¯ã€‘ï¼š{era}

ã€äººç‰©å½¢è±¡è¦æ±‚ã€‘ï¼š
1. è®¾è®¡ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆæ—¶ä»£èƒŒæ™¯çš„äººç‰©å½¢è±¡ï¼ˆç§‘å­¦å®¶ã€å®éªŒè€…ç­‰ï¼‰
2. å¤–è²Œç»†èŠ‚ï¼šå¹´é¾„ã€å‘å‹ã€é¢éƒ¨ç‰¹å¾ã€ç¥æ€
3. æœé¥°ï¼šç¬¦åˆå¯¹åº”å¹´ä»£çš„æœè£…ã€é…é¥°
4. åŠ¨ä½œç‰¹å¾ï¼šä¸å®éªŒæˆ–ç ”ç©¶ç›¸å…³çš„åŠ¨ä½œ
5. é“å…·ï¼šå®éªŒå™¨æ¢°ã€å·¥å…·ç­‰
6. å¤å¤é£æ ¼ï¼šæ£•è¤è‰²è°ƒï¼Œèƒ¶ç‰‡é¢—ç²’æ„Ÿï¼ŒæŸ”å’Œä¾§å…‰

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºäººç‰©å½¢è±¡è§„èŒƒï¼š

ã€äººç‰©1ï¼šå§“åã€‘
å¹´é¾„ï¼šXXå²
æ€§åˆ«ï¼šXX
å‘å‹ï¼šæè¿°
é¢éƒ¨ç‰¹å¾ï¼šæè¿°
æœé¥°ï¼šè¯¦ç»†æè¿°ï¼ˆå¹´ä»£ã€æè´¨ã€é¢œè‰²ï¼‰
ç¥æ€ï¼šæè¿°
åŠ¨ä½œç‰¹å¾ï¼šæè¿°
é“å…·ï¼šæè¿°
ç‰¹å†™æç¤ºè¯ï¼šè¯¦ç»†çš„è§†è§‰æè¿°ï¼Œç”¨äºç”Ÿæˆäººç‰©ç‰¹å†™å›¾ç‰‡

è¯·å¼€å§‹ç”Ÿæˆï¼š"""

    return await call_llm(prompt, temperature=0.7)


# ==================== åˆ†é•œè„šæœ¬ç”Ÿæˆ ====================
async def generate_storyboard(script: str, character_design: str) -> str:
    """ç”Ÿæˆåˆ†é•œè„šæœ¬"""
    prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹æ–‡æ¡ˆå’Œäººç‰©å½¢è±¡è§„èŒƒï¼Œç”Ÿæˆè¯¦ç»†çš„åˆ†é•œè„šæœ¬ï¼š

ã€å£æ’­æ–‡æ¡ˆã€‘ï¼š
{script}

ã€äººç‰©å½¢è±¡è§„èŒƒã€‘ï¼š
{character_design[:1500]}

ã€åˆ†é•œè¦æ±‚ã€‘ï¼š
1. æ€»æ—¶é•¿ï¼š3åˆ†é’Ÿï¼ˆçº¦180ç§’ï¼‰
2. åˆ†é•œæ•°é‡ï¼š30-35ä¸ªåˆ†é•œ
3. å•é•œæ—¶é•¿ï¼š4-6ç§’
4. é•œå¤´ç±»å‹ï¼šè¿œæ™¯ã€ä¸­æ™¯ã€è¿‘æ™¯ã€ç‰¹å†™åˆç†æ­é…
5. é•œå¤´è¿åŠ¨ï¼šå¹³ç§»ã€æ¨è¿›ã€æ‹‰è¿œç­‰è‡ªç„¶è¡”æ¥
6. ç”»é¢è¿ç»­æ€§ï¼šä¿è¯ç”»é¢çš„è¿ç»­æ€§å’Œè¡”æ¥æ€§
7. ç©ºé•œï¼šé€‚å½“åŠ å…¥ç©ºé•œï¼ˆå®éªŒåœºæ™¯ã€å†å²ç¯å¢ƒç­‰ï¼‰

ã€å¤å¤é£æ ¼ã€‘ï¼š
- æ£•è¤è‰²è°ƒ
- è½»å¾®è¤ªè‰²
- èƒ¶ç‰‡é¢—ç²’æ„Ÿ
- æŸ”å’Œé˜´å½±
- ä¸¥æ ¼ç¦æ­¢å‡ºç°ä¸å±äºæœ¬å¹´ä»£ä¹‹å¤–çš„åœºæ™¯æˆ–ç‰©å“

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
è¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç”Ÿæˆåˆ†é•œè„šæœ¬ï¼š

é•œå¤´1ï¼šã€é•œå¤´ç±»å‹ã€‘ï¼ˆXXç§’ï¼‰
ç”»é¢å†…å®¹ï¼šè¯¦ç»†æè¿°
äººç‰©åŠ¨ä½œï¼šå¦‚æœ‰
é•œå¤´è¿åŠ¨ï¼šæè¿°

é•œå¤´2ï¼šã€é•œå¤´ç±»å‹ã€‘ï¼ˆXXç§’ï¼‰
...

è¯·å¼€å§‹ç”Ÿæˆåˆ†é•œè„šæœ¬ï¼š"""

    return await call_llm(prompt, temperature=0.7)


# ==================== Veo2 æç¤ºè¯ç”Ÿæˆ ====================
async def generate_veo2_prompts(storyboard: str, era: str) -> str:
    """ç”ŸæˆVeo2æç¤ºè¯æ¸…å•"""
    prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹åˆ†é•œè„šæœ¬å’Œå¹´ä»£èƒŒæ™¯ï¼Œç”Ÿæˆç¬¦åˆVeo2æ ‡å‡†çš„è¯¦ç»†æç¤ºè¯ï¼š

ã€åˆ†é•œè„šæœ¬ã€‘ï¼š
{storyboard}

ã€å¹´ä»£èƒŒæ™¯ã€‘ï¼š{era}

ã€Veo2æç¤ºè¯æ ‡å‡†æ ¼å¼ã€‘ï¼š
ä¸»ä½“ï¼ˆSubjectï¼‰ï¼š
- è§†é¢‘çš„ä¸»è¦å¯¹è±¡æ˜¯ä»€ä¹ˆ
- å¯¹è±¡çš„ç‰¹å¾å’Œç»†èŠ‚
- å¯¹è±¡çš„æ•°é‡ï¼ˆå¦‚æœæ˜¯å¤šä¸ªï¼‰

åŠ¨ä½œï¼ˆActionï¼‰ï¼š
- åœºæ™¯ä¸­å‘ç”Ÿä»€ä¹ˆåŠ¨ä½œ
- åŠ¨ä½œçš„é€Ÿåº¦å’ŒèŠ‚å¥
- åŠ¨ä½œçš„è¿ç»­æ€§

åœºæ™¯ï¼ˆSettingï¼‰ï¼š
- ç¯å¢ƒæè¿°
- èƒŒæ™¯å…ƒç´ 
- ç©ºé—´æ„Ÿ

é•œå¤´è§’åº¦ï¼ˆCamera Angle/Movementï¼‰ï¼š
- é•œå¤´ç±»å‹ï¼ˆç‰¹å†™ã€è¿œæ™¯ç­‰ï¼‰
- é•œå¤´è¿åŠ¨ï¼ˆå¹³ç§»ã€æ¨è¿›ç­‰ï¼‰
- è§†è§’å˜åŒ–

ç¯å…‰ï¼ˆLightingï¼‰ï¼š
- å…‰æºç±»å‹
- å…‰çº¿å¼ºåº¦
- å…‰å½±æ•ˆæœ

é£æ ¼/æƒ…ç»ªï¼ˆStyle/Moodï¼‰ï¼š
- è§†è§‰é£æ ¼ï¼šæ£•è¤è‰²è°ƒï¼Œå¤å¤å†å²ç…§ç‰‡è´¨æ„Ÿï¼Œè½»å¾®è¤ªè‰²æ•ˆæœï¼Œç»†è…»èƒ¶ç‰‡é¢—ç²’æ„Ÿï¼ŒæŸ”å’Œé˜´å½±
- æƒ…æ„Ÿæ°›å›´ï¼šæ ¹æ®æ–‡æ¡ˆæƒ…ç»ªè°ƒæ•´ï¼ˆæ‚¬å¿µ/ä¸¥è‚ƒ/æ¿€æ˜‚/æ²‰é™ï¼‰
- è‰ºæœ¯æ•ˆæœï¼šå†å²çœŸå®æ„Ÿä¸æ¡£æ¡ˆæ„Ÿæ‹‰æ»¡ï¼Œæ— ä»»ä½•è·¨å¹´ä»£å…ƒç´ 

ã€è¾“å‡ºè¦æ±‚ã€‘ï¼š
- ä¸ºæ¯ä¸ªåˆ†é•œç”Ÿæˆä¸€æ¡å®Œæ•´çš„Veo2æç¤ºè¯
- ä½¿ç”¨æ¸…æ™°ã€å…·ä½“çš„æè¿°
- åŒ…å«æ‰€æœ‰å¿…è¦çš„è§†è§‰å…ƒç´ 
- ä¿æŒé€»è¾‘æ€§å’Œè¿è´¯æ€§
- é¿å…æ¨¡ç³Šæˆ–çŸ›ç›¾çš„æè¿°

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
é•œå¤´1æç¤ºè¯ï¼š
ä¸»ä½“ï¼š...
åŠ¨ä½œï¼š...
åœºæ™¯ï¼š...
é•œå¤´è§’åº¦ï¼š...
ç¯å…‰ï¼š...
é£æ ¼/æƒ…ç»ªï¼š...

é•œå¤´2æç¤ºè¯ï¼š
...

è¯·å¼€å§‹ç”ŸæˆVeo2æç¤ºè¯æ¸…å•ï¼š"""

    return await call_llm(prompt, temperature=0.6)


# ==================== ä¸»æµç¨‹ ====================
async def main():
    """ä¸»å‡½æ•°ï¼šç”Ÿæˆå…¨æµç¨‹ç´ æ"""
    parser = argparse.ArgumentParser(description="å†å²ç§‘å­¦ç±»ç§‘æ™®çŸ­è§†é¢‘ç´ æç”Ÿæˆ")
    parser.add_argument("--theme", required=True, help="ç§‘æ™®ä¸»é¢˜ï¼ˆå¦‚ï¼šè´è¶æ•ˆåº”çš„èµ·æºï¼‰")
    parser.add_argument("--era", required=True, help="å¹´ä»£èƒŒæ™¯ï¼ˆå¦‚ï¼š1961å¹´ï¼‰")
    parser.add_argument("--core_conclusion", required=True, help="æ ¸å¿ƒç§‘å­¦ç»“è®º")
    parser.add_argument("--output_dir", default="./output", help="è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼š./outputï¼‰")
    
    args = parser.parse_args()
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs(args.output_dir, exist_ok=True)
    
    print(f"ğŸ¬ å¼€å§‹ç”Ÿæˆå†å²ç§‘å­¦ç±»ç§‘æ™®çŸ­è§†é¢‘ç´ æ")
    print(f"ğŸ“Œ ä¸»é¢˜ï¼š{args.theme}")
    print(f"ğŸ“… å¹´ä»£ï¼š{args.era}")
    print(f"ğŸ’¡ æ ¸å¿ƒç»“è®ºï¼š{args.core_conclusion}")
    print(f"ğŸ“‚ è¾“å‡ºç›®å½•ï¼š{args.output_dir}")
    print()
    
    try:
        # 1. ç”Ÿæˆæ–‡æ¡ˆ
        print("ğŸ“ [1/4] ç”Ÿæˆ3åˆ†é’Ÿå£æ’­æ–‡æ¡ˆ...")
        script = await generate_script(args.theme, args.era, args.core_conclusion)
        script_path = os.path.join(args.output_dir, "script.txt")
        with open(script_path, "w", encoding="utf-8") as f:
            f.write(script)
        print(f"   âœ… æ–‡æ¡ˆå·²ç”Ÿæˆï¼š{script_path}")
        
        # 2. ç”Ÿæˆäººç‰©å½¢è±¡
        print("ğŸ‘¤ [2/4] ç”Ÿæˆäººç‰©å½¢è±¡è§„èŒƒ...")
        character_design = await generate_character_design(script, args.era)
        character_path = os.path.join(args.output_dir, "character_design.md")
        with open(character_path, "w", encoding="utf-8") as f:
            f.write(character_design)
        print(f"   âœ… äººç‰©å½¢è±¡å·²ç”Ÿæˆï¼š{character_path}")
        
        # 3. ç”Ÿæˆåˆ†é•œè„šæœ¬
        print("ğŸ¬ [3/4] ç”Ÿæˆåˆ†é•œè„šæœ¬...")
        storyboard = await generate_storyboard(script, character_design)
        storyboard_path = os.path.join(args.output_dir, "storyboard.md")
        with open(storyboard_path, "w", encoding="utf-8") as f:
            f.write(storyboard)
        print(f"   âœ… åˆ†é•œè„šæœ¬å·²ç”Ÿæˆï¼š{storyboard_path}")
        
        # 4. ç”ŸæˆVeo2æç¤ºè¯
        print("ğŸ¨ [4/4] ç”ŸæˆVeo2æç¤ºè¯æ¸…å•...")
        veo2_prompts = await generate_veo2_prompts(storyboard, args.era)
        prompts_path = os.path.join(args.output_dir, "veo2_prompts.txt")
        with open(prompts_path, "w", encoding="utf-8") as f:
            f.write(veo2_prompts)
        print(f"   âœ… Veo2æç¤ºè¯å·²ç”Ÿæˆï¼š{prompts_path}")
        
        print()
        print("ğŸ‰ æ‰€æœ‰ç´ æç”Ÿæˆå®Œæˆï¼")
        print(f"ğŸ“¦ ç´ æåŒ…ä½ç½®ï¼š{args.output_dir}/")
        print("   - script.txt           ï¼ˆ3åˆ†é’Ÿå£æ’­æ–‡æ¡ˆï¼‰")
        print("   - storyboard.md        ï¼ˆåˆ†é•œè„šæœ¬è¡¨ï¼‰")
        print("   - veo2_prompts.txt     ï¼ˆVeo2æç¤ºè¯æ¸…å•ï¼‰")
        print("   - character_design.md  ï¼ˆäººç‰©å½¢è±¡è§„èŒƒï¼‰")
        print()
        print("ğŸ’¡ ä¸‹ä¸€æ­¥ï¼šä½¿ç”¨ Veo2 æç¤ºè¯åœ¨å³æ¢¦å¹³å°ç”Ÿæˆè§†é¢‘ç´ æ")
        
    except Exception as e:
        print(f"\nâŒ ç”Ÿæˆå¤±è´¥ï¼š{str(e)}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
