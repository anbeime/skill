<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS æµ‹è¯• - ä»»å˜‰ä¼¦AIä¼´ä¾£</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #10b981;
            color: white;
        }
        .btn-secondary:hover {
            background: #059669;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        #log {
            max-height: 300px;
            overflow-y: auto;
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ TTS æµ‹è¯•é¡µé¢</h1>
        <p style="text-align: center; color: #666;">ä»»å˜‰ä¼¦AIä¼´ä¾£ - è¯­éŸ³åˆæˆæµ‹è¯•</p>

        <div class="test-section">
            <h3>1. æµè§ˆå™¨ TTS æµ‹è¯•</h3>
            <p>æµ‹è¯•æµè§ˆå™¨è‡ªå¸¦çš„è¯­éŸ³åˆæˆåŠŸèƒ½ï¼š</p>
            <input type="text" id="browserText" value="ä½ å¥½ï¼Œæˆ‘æ˜¯ä»»å˜‰ä¼¦" placeholder="è¾“å…¥æµ‹è¯•æ–‡æœ¬">
            <button class="btn-secondary" onclick="testBrowserTTS()">ğŸ”Š æ’­æ”¾æµè§ˆå™¨TTS</button>
            <div id="browserStatus"></div>
        </div>

        <div class="test-section">
            <h3>2. GPT-SoVITS TTS æµ‹è¯•</h3>
            <p>æµ‹è¯• GPT-SoVITS è¯­éŸ³å…‹éš†åŠŸèƒ½ï¼š</p>
            <input type="text" id="gptText" value="ä½ å¥½ï¼Œæˆ‘æ˜¯ä»»å˜‰ä¼¦ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ " placeholder="è¾“å…¥æµ‹è¯•æ–‡æœ¬">
            <button class="btn-primary" onclick="testGPTSoVITS()">ğŸµ æ’­æ”¾GPT-SoVITS</button>
            <div id="gptStatus"></div>
        </div>

        <div class="test-section">
            <h3>3. æœåŠ¡çŠ¶æ€æ£€æŸ¥</h3>
            <button class="btn-primary" onclick="checkServices()">ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
            <div id="serviceStatus"></div>
        </div>

        <div class="test-section">
            <h3>4. è°ƒè¯•æ—¥å¿—</h3>
            <div id="log"></div>
            <button class="btn-secondary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        const GPT_SOVITS_URL = 'http://localhost:9880';  // API ç«¯å£
        const GPT_SOVITS_WEBUI_URL = 'http://localhost:9874';  // WebUI ç«¯å£
        const REF_AUDIO_PATH = 'D:/tool/skill/projects/xiaoyue-web/tts_audio/02_çº¢äººé¢å¯¹é¢_é‡‡è®¿.wav';
        const REF_TEXT = 'å¤§å®¶å¥½';
        let currentAudio = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#60a5fa';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // æµ‹è¯•æµè§ˆå™¨ TTS
        function testBrowserTTS() {
            const text = document.getElementById('browserText').value;
            log(`æµ‹è¯•æµè§ˆå™¨TTS: "${text}"`);

            if (!window.speechSynthesis) {
                showStatus('browserStatus', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ', 'error');
                log('æµè§ˆå™¨ä¸æ”¯æŒ speechSynthesis', 'error');
                return;
            }

            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.0;
                utterance.pitch = 1.1;

                utterance.onstart = () => {
                    log('æµè§ˆå™¨TTSå¼€å§‹æ’­æ”¾', 'success');
                    showStatus('browserStatus', 'ğŸ”Š æ­£åœ¨æ’­æ”¾...', 'info');
                };

                utterance.onend = () => {
                    log('æµè§ˆå™¨TTSæ’­æ”¾å®Œæˆ', 'success');
                    showStatus('browserStatus', 'âœ… æ’­æ”¾å®Œæˆ', 'success');
                };

                utterance.onerror = (e) => {
                    log(`æµè§ˆå™¨TTSé”™è¯¯: ${e.error}`, 'error');
                    showStatus('browserStatus', `âŒ é”™è¯¯: ${e.error}`, 'error');
                };

                const voices = window.speechSynthesis.getVoices();
                const chineseVoice = voices.find(v => v.lang.includes('zh'));
                if (chineseVoice) {
                    utterance.voice = chineseVoice;
                    log(`ä½¿ç”¨è¯­éŸ³: ${chineseVoice.name}`);
                }

                window.speechSynthesis.speak(utterance);
            } catch (error) {
                log(`æµè§ˆå™¨TTSå¼‚å¸¸: ${error.message}`, 'error');
                showStatus('browserStatus', `âŒ å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯• GPT-SoVITS
        async function testGPTSoVITS() {
            const text = document.getElementById('gptText').value;
            log(`æµ‹è¯•GPT-SoVITS TTS: "${text}"`);
            showStatus('gptStatus', 'â³ æ­£åœ¨ç”Ÿæˆè¯­éŸ³...', 'info');

            try {
                // åœæ­¢å½“å‰æ’­æ”¾
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                // æ„å»º URL - ä½¿ç”¨ API v2 å‚æ•°æ ¼å¼
                const params = new URLSearchParams({
                    ref_audio_path: REF_AUDIO_PATH,        // API v2 å‚æ•°å
                    prompt_text: REF_TEXT,
                    prompt_lang: 'zh',                      // API v2 å‚æ•°å
                    text: text,
                    text_lang: 'zh',                        // API v2 å‚æ•°å
                    text_split_method: 'cut5',             // æ·»åŠ æ–‡æœ¬åˆ†å‰²æ–¹æ³•
                    media_type: 'wav'                       // æŒ‡å®šè¿”å›æ ¼å¼
                });
                // ä½¿ç”¨ API ç«¯å£ï¼ˆ9880ï¼‰å’Œ /tts endpoint
                const url = `${GPT_SOVITS_URL}/tts?${params.toString()}`; // ä¿®æ­£ï¼šä½¿ç”¨ API ç«¯å£å’Œ /tts è·¯å¾„
                log(`è¯·æ±‚URL: ${url.substring(0, 100)}...`); // è°ƒè¯•ï¼šæ‰“å°å®é™…è¯·æ±‚çš„URL
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœ API ä¸å¯ç”¨ï¼Œå°è¯• WebUI
                // const url = `${GPT_SOVITS_WEBUI_URL}/?${params.toString()}`; // æ—§ä»£ç ï¼šé”™è¯¯åœ°è°ƒç”¨äº†WebUIç«¯å£ï¼Œè¿”å›çš„æ˜¯HTMLé¡µé¢è€ŒééŸ³é¢‘æ•°æ®ã€‚å·²ä¿®æ­£ä¸ºè°ƒç”¨APIç«¯å£9880çš„/ttsæ¥å£ã€‚
                log(`è¯·æ±‚URL: ${url.substring(0, 100)}...`);

                // è°ƒç”¨ API
                const response = await fetch(url);
                log(`APIå“åº”çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // è·å–éŸ³é¢‘
                const audioBlob = await response.blob();
                log(`éŸ³é¢‘å¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`, 'success');

                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);

                // é”™è¯¯å¤„ç†
                currentAudio.onerror = (e) => {
                    log(`éŸ³é¢‘æ’­æ”¾é”™è¯¯: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    showStatus('gptStatus', 'âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥', 'error');
                };

                // æ’­æ”¾äº‹ä»¶
                currentAudio.onplay = () => {
                    log('éŸ³é¢‘å¼€å§‹æ’­æ”¾', 'success');
                    showStatus('gptStatus', 'ğŸ”Š æ­£åœ¨æ’­æ”¾ä»»å˜‰ä¼¦è¯­éŸ³...', 'info');
                };

                currentAudio.onended = () => {
                    log('éŸ³é¢‘æ’­æ”¾å®Œæˆ', 'success');
                    showStatus('gptStatus', 'âœ… æ’­æ”¾å®Œæˆ', 'success');
                    URL.revokeObjectURL(audioUrl);
                };

                // å°è¯•æ’­æ”¾
                const playPromise = currentAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        log(`æ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
                        showStatus('gptStatus', `âŒ æ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
                    });
                }

            } catch (error) {
                log(`GPT-SoVITSé”™è¯¯: ${error.message}`, 'error');
                showStatus('gptStatus', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServices() {
            log('æ£€æŸ¥æœåŠ¡çŠ¶æ€...');
            const statusDiv = document.getElementById('serviceStatus');
            statusDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨æ£€æŸ¥...</div>';

            let html = '';

            // æ£€æŸ¥å°æ˜“æœåŠ¡
            try {
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                log('å°æ˜“æœåŠ¡: æ­£å¸¸è¿è¡Œ', 'success');
                html += '<div class="status success">âœ… å°æ˜“ä¼´ä¾£æœåŠ¡: æ­£å¸¸</div>';
            } catch (error) {
                log(`å°æ˜“æœåŠ¡é”™è¯¯: ${error.message}`, 'error');
                html += '<div class="status error">âŒ å°æ˜“ä¼´ä¾£æœåŠ¡: æœªè¿è¡Œ</div>';
            }

            // æ£€æŸ¥ GPT-SoVITS
            try {
                const response = await fetch('http://localhost:9874/');
                if (response.ok) {
                    log('GPT-SoVITSæœåŠ¡: æ­£å¸¸è¿è¡Œ', 'success');
                    html += '<div class="status success">âœ… GPT-SoVITSæœåŠ¡: æ­£å¸¸</div>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`GPT-SoVITSé”™è¯¯: ${error.message}`, 'error');
                html += '<div class="status error">âŒ GPT-SoVITSæœåŠ¡: æœªè¿è¡Œ</div>';
            }

            // æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶
            try {
                const response = await fetch('http://localhost:3001/tts_audio/02_%E7%BA%A2%E4%BA%BA%E9%9D%A2%E5%AF%B9%E9%9D%A2_%E9%87%87%E8%AE%BF.wav', { method: 'HEAD' });
                if (response.ok) {
                    log('å‚è€ƒéŸ³é¢‘æ–‡ä»¶: å¯è®¿é—®', 'success');
                    html += '<div class="status success">âœ… å‚è€ƒéŸ³é¢‘æ–‡ä»¶: å¯è®¿é—®</div>';
                } else {
                    throw new Error('ä¸å¯è®¿é—®');
                }
            } catch (error) {
                log(`å‚è€ƒéŸ³é¢‘æ–‡ä»¶: ${error.message}`, 'error');
                html += '<div class="status error">âŒ å‚è€ƒéŸ³é¢‘æ–‡ä»¶: ä¸å¯è®¿é—®</div>';
            }

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (window.speechSynthesis) {
                log('æµè§ˆå™¨TTSæ”¯æŒ: æ˜¯', 'success');
                html += '<div class="status success">âœ… æµè§ˆå™¨TTS: æ”¯æŒ</div>';
            } else {
                log('æµè§ˆå™¨TTSæ”¯æŒ: å¦', 'error');
                html += '<div class="status error">âŒ æµè§ˆå™¨TTS: ä¸æ”¯æŒ</div>';
            }

            statusDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            checkServices();
        };
    </script>
</body>
</html>
